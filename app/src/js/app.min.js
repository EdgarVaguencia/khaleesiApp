"use strict";var _=require("underscore"),Backbone=require("backbone"),jQuery=require("jquery"),jsonfile=require("jsonfile"),util=require("util"),Khaleesi={Models:{},Collections:{},Views:{},Router:{},Options:{urlBase:"http://localhost:8000",urlBoard:"/api/v1/pizarron/",urlTarea:"/api/v1/tarea/",urlUser:"/api/v1/user/",urlDataJson:"?format=json"}};window.Khaleesi=Khaleesi,Khaleesi.Models.Sync=Backbone.Model.extend({defaults:{user:"",token:"",first_name:"",last_name:"",ide:"",resource:""},initialize:function(){this.listenTo(this,"change",this.writeFile),this.readData()},datafile:__dirname+"/data.json",readData:function(){const e=this;var t=jsonfile.readFileSync(this.datafile);null!==t&&e.set({user:t.user,token:t.token})},writeFile:function(){const e=this;var t={token:this.get("token"),user:this.get("user"),first_name:this.get("first_name"),last_name:this.get("last_name"),ide:this.get("ide"),resource:this.get("resource")};jsonfile.writeFile(e.datafile,t,function(e){null!==e&&console.error(e)})}}),Khaleesi.Models.Tarea=Backbone.Model.extend({}),Khaleesi.Collections.Tareas=Backbone.Collection.extend({model:Khaleesi.Models.Tarea}),Khaleesi.Views.List=Backbone.View.extend({className:"pane",events:{drop:"droped"},template:_.template('<h4>Tareas <%= title %></h4><ul class="list-group list-content"></ul>'),tareaTemplate:_.template('<span class="pull-left icon icon-layout"></span><div class="media-body"><span><%= name %></span>, <span><%= description %></span></div>'),initialize:function(e){this.listenTo(this.collection,"add",this.addTarea,this),this.listenTo(this.collection,"remove",this.update,this),this.title=void 0!==e?e.title:"",this._status=void 0!==e?e._status:0},render:function(){return this.$el.empty(),this.$el.html(this.template({title:this.title})),this},addTarea:function(e){var t=jQuery("<li/>",{"class":"list-group-item droptask","data-ide":e.get("ide")}).append(this.tareaTemplate(e.toJSON()));this.$el.find("ul").append(t),t.draggable({revert:"invalid",helper:"clone"})},droped:function(e,t){var s=t.draggable.data("ide"),i=Khaleesi.app.tareas.findWhere({ide:s});i.set({status:this._status}),t.draggable.remove()},update:function(){this.collection.forEach(this.addTarea,this)}}),Khaleesi.Views.Mensajes=Backbone.View.extend({el:jQuery("body"),template:_.template('<div class="alert" id="msj_system" role="alert" style="display: none; position: fixed; text-align: center; top: 0; width: 100%; z-index: 1024;"><span id="msjTxt"><%= txt %></span></div>'),render:function(e){this.$el.append(this.template({txt:e})),jQuery("#msj_system").fadeIn(1400).delay(1600).fadeOut(1400,function(){jQuery(this).detach()})}}),Khaleesi.Views.Dashboard=Backbone.View.extend({el:jQuery(".nav"),events:{"click .task":"taskView","click .setting":"optionView"},initialize:function(){this.listenTo(this.model,"change",this.userView,this)},taskView:function(e){this.$el.find("a.active").removeClass("active"),jQuery(e.target).parent().addClass("active"),Khaleesi.app.navigate("",{trigger:!0})},optionView:function(e){this.$el.find("a.active").removeClass("active"),jQuery(e.target).parent().addClass("active"),Khaleesi.app.navigate("settings/",{trigger:!0})},userView:function(){this.$el.find("#user").html(this.model.get("first_name"))}}),Khaleesi.Views.Options=Backbone.View.extend({el:jQuery(".window-body"),events:{"change #user":"saveUser","change #token":"saveToken"},template:_.template('<div class="pane"><form><div class="form-group"><label for="">Nombre de usuario</label><input type="text" class="form-control" placeholder="Username" value="<%= user %>" id="user" /></div><div class="form-group"><label for="">Api key</label><input type="text" class="form-control" placeholder="Token" value="<%= token %>" id="token" /></div></form></div>'),render:function(){var e=Khaleesi.app.sync.toJSON();this.$el.html(this.template(e))},saveUser:function(e){void 0!==e.target&&e.target.value.length>0&&(Khaleesi.app.sync.set("user",e.target.value),Khaleesi.app.msj.render("Guardado"))},saveToken:function(e){void 0!==e.target&&e.target.value.length>0&&(Khaleesi.app.sync.set("token",e.target.value),Khaleesi.app.msj.render("Guardado"))}}),Khaleesi.Views.Tareas=Backbone.View.extend({el:jQuery(".window-body"),initialize:function(){this.listenTo(this.collection,"add",this.addTarea,this),this.listenTo(this.collection,"change",this.changeTarea,this),this.pendientes=new Khaleesi.Collections.Tareas,this.proceso=new Khaleesi.Collections.Tareas,this.pausadas=new Khaleesi.Collections.Tareas,this.terminadas=new Khaleesi.Collections.Tareas,this.bloqueadas=new Khaleesi.Collections.Tareas,this.listPendientes=new Khaleesi.Views.List({title:"pendientes",collection:this.pendientes,_status:1}),this.listProceso=new Khaleesi.Views.List({title:"en proceso",collection:this.proceso,_status:2}),this.listPausadas=new Khaleesi.Views.List({title:"pausadas",collection:this.pausadas,_status:3}),this.listTerminadas=new Khaleesi.Views.List({title:"terminadas",collection:this.terminadas,_status:4}),this.listBloqueadas=new Khaleesi.Views.List({title:"terminadas",collection:this.bloqueadas,_status:5})},render:function(){this.$el.html("").append(this.listPendientes.render().el,this.listProceso.render().el,this.listPausadas.render().el,this.listTerminadas.render().el),this.$el.find("ul.list-group").droppable({accept:"li.droptask",hoverClass:"highlight"}),this.collection.forEach(this.addTarea,this)},addTarea:function(e){const t=this;1===e.get("status")?t.pendientes.add(e):2===e.get("status")?t.proceso.add(e):3===e.get("status")?t.pausadas.add(e):4===e.get("status")?t.terminadas.add(e):5===e.get("status")&&t.bloqueadas.add(e)},changeTarea:function(e){this.removeList(e.previous("status"),e),this.addList(e.get("status"),e)},removeList:function(e,t){1===e?this.pendientes.remove(t):2===e?this.proceso.remove(t):3===e?this.pausadas.remove(t):4===e?this.terminadas.remove(t):5===e&&this.bloqueadas.remove(t)},addList:function(e,t){var s=Khaleesi.app.request({url:Khaleesi.Options.urlBase+Khaleesi.Options.urlBoard,method:"POST",data:[{tarea:t.get("resource"),status:e,created_by:Khaleesi.app.sync.get("resource")}]});null!==s&&s.done(function(e){console.log(e)}),1===e?this.pendientes.add(t):2===e?this.proceso.add(t):3===e?this.pausadas.add(t):4===e?this.terminadas.add(t):5===e&&this.bloqueadas.add(t)}}),Khaleesi.Router=Backbone.Router.extend({routes:{"":"tasks","settings/":"options"},initialize:function(){this.sync=new Khaleesi.Models.Sync,this.tareas=new Khaleesi.Collections.Tareas,this.nav=new Khaleesi.Views.Dashboard({model:this.sync}),this.listTareas=new Khaleesi.Views.Tareas({collection:this.tareas}),this.configurations=new Khaleesi.Views.Options,this.msj=new Khaleesi.Views.Mensajes,this.userView(),Backbone.history.start()},userView:function(){this.sync.get("token").length>0&&this.sync.get("user").length>0&&this.fetchUser()},tasks:function(){this.sync.get("token").length>0&&this.sync.get("user").length>0&&(""!==this.sync.get("first_name")&&this.fetchUser(),this.listTareas.render(),this.fetchTareas())},request:function(e){var t=e.url,s=void 0!==e.data?JSON.stringify(e.data[0]):"",i=void 0!==e.method?e.method:"get";return Backbone.ajax({headers:{Authorization:"ApiKey "+this.sync.get("user")+":"+this.sync.get("token")},contentType:"application/json",processData:!1,url:t,method:i,data:s})},fetchTareas:function(){const e=this;var t=this.request({url:Khaleesi.Options.urlBase+"/api/v1/tarea/"+Khaleesi.Options.urlDataJson});null!==t&&t.done(function(t){t.meta.total_count>0&&_.each(t.objects,function(t){var s=new Khaleesi.Models.Tarea({description:t.descripcion,end:t.fecha_final,hours:t.horas_estimadas,ide:t.id,name:t.nombre,resource:t.resource_uri,status:t.pizarron_status});e.tareas.add(s)})})},fetchUser:function(){const e=this;var t=this.request({url:Khaleesi.Options.urlBase+Khaleesi.Options.urlUser+Khaleesi.Options.urlDataJson});null!==t&&t.done(function(t){var s=t.objects[0];e.sync.set("first_name",s.first_name),e.sync.set("last_name",s.last_name),e.sync.set("ide",s.id),e.sync.set("resource",s.resource_uri)})},options:function(){this.configurations.render()}}),jQuery(function(){Khaleesi.app=new Khaleesi.Router});